name: Basic

on:
    push:
        branches:
            - main
    pull_request:
        branches: [ main ]

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: CD
        steps:
            - uses: actions/checkout@v4

            - name: Build
              run: docker buildx build --cache-from=type=gha --cache-to=type=gha,mode=max -t craft:latest .
            
            - name: Zip and upload
              run: docker save craft:latest | gzip > craft.tar.gz

            - name: Restore ssh key
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.SSH_KEY }}" > ~/.ssh/github_cd.pem
                chmod 400 ~/.ssh/github_cd.pem
            
            - name: Add known hosts
              run: |
                ssh-keyscan -H ${{ secrets.KNOWN_HOSTS }} >> ~/.ssh/known_hosts

            - name: Connect to server
              run: |
                scp -i ~/.ssh/github_cd.pem craft.tar.gz ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/root/craft.tar.gz

            - name: Deploy
              run: |
                ssh -v -i ~/.ssh/github_cd.pem ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
                docker load < ~/craft.tar.gz
                docker stop craft || true
                docker rm craft || true
                docker run -d --name craft -p 8000:8000 craft:latest
                EOF
            
            - name: Cleanup
              run: |
                rm ~/.ssh/github_cd.pem