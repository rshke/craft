name: Basic

on:
    push:
        branches:
            - main
    pull_request:
        branches: [ main ]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: build
              run: docker build -t craft:latest .
            
            - name: zip and upload
              run: docker save craft:latest | gzip > craft.tar.gz

            - name: restore ssh key
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.SSH_KEY }}" > ~/.ssh/github_cd.pem
                chmod 400 ~/.ssh/github_cd.pem

            - name: connect to server
              run: |
                scp -i ~/.ssh/github_cd.pem craft.tar.gz ${{ secrets.USERNAME }}@${{ secrets.HOST }}:~/craft.tar.gz

            - name: deploy
              run: |
                ssh -i ~/.ssh/github_cd.pem ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
                docker load < ~/craft.tar.gz
                docker stop craft || true
                docker rm craft || true
                docker run -d --name craft -p 8000:8000 craft:latest
                EOF
            
            - name: cleanup
              run: |
                rm ~/.ssh/github_cd.pem